"""
é€å¹³æœºæ¢°åŸç†è¯¾ç¨‹ç³»ç»Ÿ - å®Œæ•´æ•´åˆç‰ˆ
æ•´åˆ MultiDocumentKnowledgeBase (RAG) + LangGraph Agent

ä½¿ç”¨æ–¹æ³•:
1. è®¾ç½®ç¯å¢ƒå˜é‡ OPENAI_API_KEY
2. è¿è¡Œç¨‹åº
3. å…ˆæ·»åŠ è¯¾ç¨‹æ–‡æ¡£ï¼ˆPDFã€Wordç­‰ï¼‰
4. ç„¶åå¯ä»¥è¿›è¡Œé—®ç­”ã€ç”Ÿæˆç»ƒä¹ é¢˜ã€æ‰¹æ”¹ä½œä¸šç­‰æ“ä½œ
"""

import os
import sys
from pathlib import Path

# æ·»åŠ å½“å‰ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent))

# å¯¼å…¥åŸå§‹RAGç³»ç»Ÿçš„æ‰€æœ‰ç»„ä»¶
# æ³¨æ„ï¼šä»¥ä¸‹å¯¼å…¥å‡è®¾ç”¨æˆ·çš„åŸå§‹ä»£ç æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹
# ç”¨æˆ·éœ€è¦å°†åŸå§‹çš„å¤šæ¨¡æ€RAGä»£ç ä¿å­˜ä¸º multimodal_rag.py

try:
    from multimodel_rag import (
        MultiDocumentKnowledgeBase,
        UnstructuredPDFParser,
        ChunkStore,
        ChunkData,
        ChineseBM25Retriever
    )

    RAG_AVAILABLE = True
except ImportError:
    print("è­¦å‘Š: æœªæ‰¾åˆ° multimodel_rag.pyï¼ŒRAGåŠŸèƒ½å°†ä¸å¯ç”¨")
    print("è¯·å°†åŸå§‹çš„å¤šæ¨¡æ€RAGä»£ç ä¿å­˜ä¸º multimodel_rag.py")
    RAG_AVAILABLE = False
    MultiDocumentKnowledgeBase = None

# å¯¼å…¥ LangGraph Agent
from turbine_course_agent import TurbineCourseAgent, create_agent_with_custom_model

# å…¶ä»–å¿…è¦çš„å¯¼å…¥
from langchain_openai import ChatOpenAI
import logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


class TurbineMachinerySystem:
    """
    é€å¹³æœºæ¢°åŸç†è¯¾ç¨‹å®Œæ•´ç³»ç»Ÿ
    æ•´åˆäº†:
    - å¤šæ¨¡æ€RAGçŸ¥è¯†åº“
    - LangGraphæ™ºèƒ½ä½“Agent
    - é—®ç­”ã€ç»ƒä¹ é¢˜ç”Ÿæˆã€ä½œä¸šæ‰¹æ”¹åŠŸèƒ½
    """

    def __init__(
            self,
            kb_path: str = "./multimodel_doc_kb_memory_qwen_chunk",
            openai_api_key: str = None,
            openai_api_base: str = None,
            model_name: str = "gpt-5-1",
            custom_llm=None
    ):
        """
        åˆå§‹åŒ–ç³»ç»Ÿ

        Args:
            kb_path: çŸ¥è¯†åº“å­˜å‚¨è·¯å¾„
            openai_api_key: OpenAI API Key
            openai_api_base: API Base URL (å¯é€‰ï¼Œç”¨äºä»£ç†)
            model_name: ä½¿ç”¨çš„æ¨¡å‹åç§°
            custom_llm: ç”¨æˆ·è‡ªå®šä¹‰çš„å¾®è°ƒæ¨¡å‹ (å¯é€‰)
        """
        self.kb_path = Path(kb_path)
        self.kb_path.mkdir(parents=True, exist_ok=True)

        # APIé…ç½®
        self._api_key = openai_api_key or os.getenv("OPENAI_API_KEY")
        self._api_base = openai_api_base or os.getenv("OPENAI_API_BASE", "https://api.zchat.tech/v1")
        self._model_name = model_name

        if not self._api_key:
            raise ValueError("è¯·æä¾› OPENAI_API_KEY")

        # åˆå§‹åŒ–LLM
        self.llm = ChatOpenAI(
            openai_api_key=self._api_key,
            openai_api_base=self._api_base,
            model=self._model_name,
            temperature=0.3
        )

        # è‡ªå®šä¹‰LLM (å¦‚æœæä¾›)
        self.custom_llm = custom_llm

        # åˆå§‹åŒ–çŸ¥è¯†åº“ (å¦‚æœå¯ç”¨)
        self.knowledge_base = None
        if RAG_AVAILABLE and MultiDocumentKnowledgeBase:
            try:
                self.knowledge_base = MultiDocumentKnowledgeBase(
                    str(self.kb_path ),
                    openai_api_key=self._api_key
                )
                logger.info("å¤šæ¨¡æ€RAGçŸ¥è¯†åº“åˆå§‹åŒ–æˆåŠŸ")
            except Exception as e:
                logger.error(f"çŸ¥è¯†åº“åˆå§‹åŒ–å¤±è´¥: {e}")
                self.knowledge_base = None

        # åˆå§‹åŒ– Agent
        self.agent = TurbineCourseAgent(
            knowledge_base=self.knowledge_base,
            llm=self.custom_llm or self.llm
        )

        # å½“å‰ä¼šè¯ID
        self.current_session_id = "default_session"

        logger.info("é€å¹³æœºæ¢°åŸç†è¯¾ç¨‹ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")

    # ========================================
    # çŸ¥è¯†åº“ç®¡ç†åŠŸèƒ½
    # ========================================

    def add_document(self, file_path: str):
        """æ·»åŠ æ–‡æ¡£åˆ°çŸ¥è¯†åº“"""
        if not self.knowledge_base:
            print("âŒ çŸ¥è¯†åº“ä¸å¯ç”¨")
            return False

        try:
            self.knowledge_base.add_document(file_path)
            print(f"âœ… æ–‡æ¡£æ·»åŠ æˆåŠŸ: {Path(file_path).name}")
            return True
        except Exception as e:
            print(f"âŒ æ·»åŠ å¤±è´¥: {e}")
            return False

    def add_documents_from_directory(self, directory_path: str):
        """ä»ç›®å½•æ‰¹é‡æ·»åŠ æ–‡æ¡£"""
        if not self.knowledge_base:
            print("âŒ çŸ¥è¯†åº“ä¸å¯ç”¨")
            return False

        try:
            self.knowledge_base.add_documents_from_directory(directory_path)
            print(f"âœ… ç›®å½•æ–‡æ¡£æ·»åŠ å®Œæˆ: {directory_path}")
            return True
        except Exception as e:
            print(f"âŒ æ·»åŠ å¤±è´¥: {e}")
            return False

    def list_documents(self):
        """åˆ—å‡ºçŸ¥è¯†åº“ä¸­çš„æ‰€æœ‰æ–‡æ¡£"""
        if not self.knowledge_base:
            print("âŒ çŸ¥è¯†åº“ä¸å¯ç”¨")
            return {}

        return self.knowledge_base.list_documents()

    def delete_document(self, file_path: str):
        """åˆ é™¤æŒ‡å®šæ–‡æ¡£"""
        if not self.knowledge_base:
            print("âŒ çŸ¥è¯†åº“ä¸å¯ç”¨")
            return False

        try:
            self.knowledge_base.delete_document(file_path)
            print(f"âœ… æ–‡æ¡£å·²åˆ é™¤")
            return True
        except Exception as e:
            print(f"âŒ åˆ é™¤å¤±è´¥: {e}")
            return False

    # ========================================
    # Agent äº¤äº’åŠŸèƒ½
    # ========================================

    def chat(self, user_input: str, **kwargs):
        """
        ä¸Agentå¯¹è¯

        Args:
            user_input: ç”¨æˆ·è¾“å…¥
            **kwargs: é¢å¤–å‚æ•°

        Returns:
            Agentå“åº”ç»“æœ
        """
        return self.agent.chat(
            user_input,
            session_id=self.current_session_id,
            **kwargs
        )

    def ask_question(self, question: str):
        """
        æé—®ï¼ˆé—®ç­”æ¨¡å¼ï¼‰

        Args:
            question: é—®é¢˜
        """
        result = self.chat(question)
        return result["response"]

    def generate_questions(
            self,
            chapter: str,
            question_type: str = "short_answer",
            count: int = 5,
            difficulty: str = "medium"
    ):
        """
        ç”Ÿæˆç»ƒä¹ é¢˜

        Args:
            chapter: ç« èŠ‚åç§°
            question_type: é¢˜å‹ (choice/fill_blank/short_answer/calculation)
            count: é¢˜ç›®æ•°é‡
            difficulty: éš¾åº¦ (easy/medium/hard)
        """
        return self.agent.generate_questions(
            chapter=chapter,
            question_type=question_type,
            count=count,
            difficulty=difficulty
        )

    def grade_homework(self, student_answer: str, reference: str = "", reference_file: str = ""):
        """
        Args:
            student_answer: å­¦ç”Ÿç­”æ¡ˆ
            reference: å‚è€ƒç­”æ¡ˆ/è¯„åˆ†æ ‡å‡†ï¼ˆæ–‡æœ¬ï¼‰
            reference_file: å‚è€ƒç­”æ¡ˆæ–‡ä»¶è·¯å¾„ï¼ˆPDFç­‰ï¼‰
        """
        final_reference = reference

        # å¦‚æœæä¾›äº†å‚è€ƒæ–‡ä»¶ï¼Œè§£æå¹¶è¿½åŠ åˆ°å‚è€ƒå†…å®¹ä¸­
        if reference_file:
            if self.knowledge_base:
                print(f"â³ æ­£åœ¨è¯»å–å‚è€ƒæ–‡ä»¶: {reference_file} ...")
                file_content = self.knowledge_base.parse_local_file(reference_file)
                if file_content:
                    if final_reference:
                        final_reference += f"\n\nã€å‚è€ƒæ–‡æ¡£å†…å®¹ã€‘\n{file_content}"
                    else:
                        final_reference = f"ã€å‚è€ƒæ–‡æ¡£å†…å®¹ã€‘\n{file_content}"
            else:
                print("âš ï¸ çŸ¥è¯†åº“æ¨¡å—æœªåˆå§‹åŒ–ï¼Œæ— æ³•è§£æå‚è€ƒæ–‡ä»¶ï¼Œå°†ä»…ä½¿ç”¨æ–‡æœ¬å‚è€ƒã€‚")

        return self.agent.grade_answer(
            student_answer=student_answer,
            reference=final_reference
        )

    def summarize_chapter(self, chapter_name: str):
        """
        æ€»ç»“ç« èŠ‚çŸ¥è¯†ç‚¹

        Args:
            chapter_name: ç« èŠ‚åç§°
        """
        result = self.chat(f"æ€»ç»“{chapter_name}çš„çŸ¥è¯†ç‚¹", chapter_info=chapter_name)
        return result["response"]

    # ========================================
    # ä¼šè¯ç®¡ç†
    # ========================================

    def switch_session(self, session_id: str):
        """åˆ‡æ¢ä¼šè¯"""
        self.current_session_id = session_id
        print(f"å·²åˆ‡æ¢åˆ°ä¼šè¯: {session_id}")

    def clear_session_history(self, session_id: str = None):
        """æ¸…ç©ºä¼šè¯å†å²"""
        sid = session_id or self.current_session_id
        if self.knowledge_base:
            self.knowledge_base.clear_chat_history(session_id=sid)
        print(f"ä¼šè¯ {sid} å†å²å·²æ¸…ç©º")


def interactive_main():
    """äº¤äº’å¼ä¸»ç¨‹åº"""

    print("=" * 70)
    print("ğŸ”§ é€å¹³æœºæ¢°åŸç†è¯¾ç¨‹æ™ºèƒ½ç³»ç»Ÿ")
    print("    åŸºäºå¤šæ¨¡æ€RAG + LangGraph Agent")
    print("=" * 70)

    # æ£€æŸ¥API Key
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        print("\nâŒ è¯·å…ˆè®¾ç½® OPENAI_API_KEY ç¯å¢ƒå˜é‡")
        print("   set OPENAI_API_KEY=your-api-key       (Windows)")
        return

    # åˆå§‹åŒ–ç³»ç»Ÿ
    print("\næ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...")
    try:
        system = TurbineMachinerySystem(
            kb_path="./multimodel_doc_kb_memory_qwen_chunk",
            openai_api_base=os.getenv("OPENAI_API_BASE", "https://api.zchat.tech/v1")
        )
    except Exception as e:
        print(f"âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: {e}")
        return

    # ä¸»å¾ªç¯
    current_session = "user_session_1"
    system.switch_session(current_session)

    while True:
        print("\n" + "=" * 70)
        print(f"ğŸ“š é€å¹³æœºæ¢°åŸç†è¯¾ç¨‹ç³»ç»Ÿ | ä¼šè¯: {current_session}")
        print("=" * 70)
        print("ã€çŸ¥è¯†åº“ç®¡ç†ã€‘")
        print("  1. æ·»åŠ å•ä¸ªæ–‡æ¡£")
        print("  2. ä»æ–‡ä»¶å¤¹æ·»åŠ æ–‡æ¡£")
        print("  3. æŸ¥çœ‹çŸ¥è¯†åº“æ–‡æ¡£")
        print("  4. åˆ é™¤æ–‡æ¡£")
        print()
        print("ã€æ™ºèƒ½åŠŸèƒ½ã€‘")
        print("  5. ğŸ’¬ é—®ç­”å¯¹è¯")
        print("  6. ğŸ“ ç”Ÿæˆç»ƒä¹ é¢˜")
        print("  7. âœï¸ æ‰¹æ”¹ä½œä¸š")
        print("  8. ğŸ“– ç« èŠ‚çŸ¥è¯†ç‚¹æ€»ç»“")
        print()
        print("ã€ç³»ç»Ÿè®¾ç½®ã€‘")
        print("  9. åˆ‡æ¢/æ–°å»ºä¼šè¯")
        print("  10. æ¸…ç©ºå½“å‰ä¼šè¯å†å²")
        print("  0. é€€å‡ºç³»ç»Ÿ")
        print("=" * 70)

        choice = input("è¯·é€‰æ‹©åŠŸèƒ½ (0-10): ").strip()

        if choice == "0":
            print("\nğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨é€å¹³æœºæ¢°åŸç†è¯¾ç¨‹ç³»ç»Ÿï¼Œå†è§ï¼")
            break

        elif choice == "1":
            file_path = input("è¯·è¾“å…¥æ–‡æ¡£è·¯å¾„: ").strip().strip('"')
            if file_path:
                system.add_document(file_path)

        elif choice == "2":
            dir_path = input("è¯·è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„: ").strip().strip('"')
            if dir_path:
                system.add_documents_from_directory(dir_path)

        elif choice == "3":
            docs_info = system.list_documents()
            print("\nğŸ“š çŸ¥è¯†åº“æ–‡æ¡£åˆ—è¡¨")
            print("-" * 50)
            if docs_info.get("documents"):
                for path, meta in docs_info["documents"].items():
                    print(f"  ğŸ“„ {Path(path).name}")
                    print(f"     ç±»å‹: {meta.get('doc_type', 'N/A')}")
                    print(f"     ç‰‡æ®µæ•°: {meta.get('chunk_count', 0)}")
            else:
                print("  (ç©º)")
            print(f"\næ€»ç‰‡æ®µæ•°: {docs_info.get('total_chunks_in_memory', 0)}")

        elif choice == "4":
            file_path = input("è¯·è¾“å…¥è¦åˆ é™¤çš„æ–‡æ¡£è·¯å¾„: ").strip().strip('"')
            if file_path:
                confirm = input("ç¡®è®¤åˆ é™¤? (yes/no): ").strip().lower()
                if confirm == "yes":
                    system.delete_document(file_path)

        elif choice == "5":
            # é—®ç­”å¯¹è¯æ¨¡å¼
            print("\nğŸ’¬ è¿›å…¥é—®ç­”æ¨¡å¼ (è¾“å…¥ 'back' è¿”å›ä¸»èœå•)")
            print("-" * 50)
            while True:
                question = input("\nğŸ‘¤ æ‚¨çš„é—®é¢˜: ").strip()
                if question.lower() == 'back':
                    break
                if not question:
                    continue

                print("\nğŸ¤– åŠ©æ‰‹: ", end="")
                result = system.chat(question)
                print(result["response"])
                print(f"\n[ç½®ä¿¡åº¦: {result.get('confidence', 0):.2f}]")

        elif choice == "6":
            # ç”Ÿæˆç»ƒä¹ é¢˜
            print("\nğŸ“ ç»ƒä¹ é¢˜ç”Ÿæˆ")
            print("-" * 50)
            chapter = input("ç« èŠ‚åç§° (å¦‚: è½´æµå¼å‹ç¼©æœº): ").strip() or "é€å¹³æœºæ¢°åŸç†"

            print("é¢˜å‹é€‰æ‹©:")
            print("  1. choice - é€‰æ‹©é¢˜")
            print("  2. fill_blank - å¡«ç©ºé¢˜")
            print("  3. short_answer - ç®€ç­”é¢˜")
            print("  4. calculation - è®¡ç®—é¢˜")
            qtype_choice = input("é€‰æ‹©é¢˜å‹ (1-4, é»˜è®¤3): ").strip() or "3"
            qtype_map = {"1": "choice", "2": "fill_blank", "3": "short_answer", "4": "calculation"}
            qtype = qtype_map.get(qtype_choice, "short_answer")

            count = int(input("é¢˜ç›®æ•°é‡ (é»˜è®¤5): ").strip() or "5")

            print("éš¾åº¦é€‰æ‹©: 1.easy  2.medium  3.hard")
            diff_choice = input("é€‰æ‹©éš¾åº¦ (1-3, é»˜è®¤2): ").strip() or "2"
            diff_map = {"1": "easy", "2": "medium", "3": "hard"}
            difficulty = diff_map.get(diff_choice, "medium")

            print("\nâ³ æ­£åœ¨ç”Ÿæˆç»ƒä¹ é¢˜...")
            result = system.chat(
                f"è¯·ç”Ÿæˆ{count}é“å…³äº{chapter}çš„{qtype}ï¼Œéš¾åº¦ä¸º{difficulty}",
                chapter_info=chapter,
                question_type=qtype,
                question_count=count,
                difficulty=difficulty
            )
            print("\n" + result["response"])

        elif choice == "7":
            # æ‰¹æ”¹ä½œä¸š
            print("\nâœï¸ ä½œä¸šæ‰¹æ”¹")
            print("-" * 50)
            print("è¯·è¾“å…¥å­¦ç”Ÿç­”æ¡ˆ (è¾“å…¥å®ŒæˆåæŒ‰ä¸¤æ¬¡Enter):")
            lines = []
            while True:
                line = input()
                if line == "":
                    break
                lines.append(line)
            student_answer = "\n".join(lines)
            if student_answer.strip():
                # è¯¢é—®å‚è€ƒç­”æ¡ˆç±»å‹
                print("\nè¯·é€‰æ‹©å‚è€ƒç­”æ¡ˆ/è¯„åˆ†æ ‡å‡†æ¥æº:")
                print("1. ç›´æ¥è¾“å…¥æ–‡æœ¬")
                print("2. ä¸Šä¼ å‚è€ƒæ–‡æ¡£ (PDF/Word)")
                print("3. æ— å‚è€ƒ (ç›´æ¥è·³è¿‡)")
                ref_choice = input("è¯·è¾“å…¥é€‰æ‹© (1-3): ").strip()
                reference_text = ""
                reference_file_path = ""
                if ref_choice == "1":
                    reference_text = input("\nè¯·è¾“å…¥å‚è€ƒç­”æ¡ˆæ–‡æœ¬: ").strip()
                elif ref_choice == "2":
                    reference_file_path = input("\nè¯·è¾“å…¥å‚è€ƒæ–‡æ¡£çš„å®Œæ•´è·¯å¾„: ").strip().strip('"')
                print("\nâ³ æ­£åœ¨æ‰¹æ”¹...")
                result = system.grade_homework(
                    student_answer=student_answer,
                    reference=reference_text,
                    reference_file=reference_file_path
                )
                print("\n" + result["response"])
            else:
                print("âŒ æœªè¾“å…¥ç­”æ¡ˆå†…å®¹")

        elif choice == "8":
            # ç« èŠ‚æ€»ç»“
            print("\nğŸ“– ç« èŠ‚çŸ¥è¯†ç‚¹æ€»ç»“")
            print("-" * 50)
            chapter = input("è¯·è¾“å…¥ç« èŠ‚åç§° (å¦‚: ç¦»å¿ƒå¼å‹ç¼©æœº): ").strip()
            if chapter:
                print("\nâ³ æ­£åœ¨ç”Ÿæˆæ€»ç»“...")
                summary = system.summarize_chapter(chapter)
                print("\n" + summary)

        elif choice == "9":
            new_session = input(f"è¯·è¾“å…¥æ–°ä¼šè¯ID (å½“å‰: {current_session}): ").strip()
            if new_session:
                current_session = new_session
                system.switch_session(current_session)

        elif choice == "10":
            confirm = input("ç¡®è®¤æ¸…ç©ºå½“å‰ä¼šè¯å†å²? (yes/no): ").strip().lower()
            if confirm == "yes":
                system.clear_session_history()

        else:
            print("âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥")


if __name__ == "__main__":
    interactive_main()
