import streamlit as st
import os
import tempfile
import shutil
from pathlib import Path
import time

# å¯¼å…¥åç«¯ç³»ç»Ÿ
try:
    from turbine_system_integration import TurbineMachinerySystem
except ImportError:
    st.error(
        "æ— æ³•å¯¼å…¥åç«¯æ¨¡å—ï¼Œè¯·ç¡®ä¿ 'turbine_system_integration.py', 'turbine_course_agent.py', 'multimodel_rag.py' åœ¨åŒä¸€ç›®å½•ä¸‹ã€‚")
    st.stop()

# ==========================================
# é¡µé¢é…ç½®
# ==========================================
st.set_page_config(
    page_title="é€å¹³æœºæ¢°åŸç†æ™ºèƒ½æ•™å­¦ç³»ç»Ÿ",
    page_icon="âš™ï¸",
    layout="wide",
    initial_sidebar_state="expanded"
)

# è‡ªå®šä¹‰ CSS æ ·å¼
st.markdown("""
<style>
    .stChatMessage {
        background-color: #f0f2f6;
        border-radius: 10px;
        padding: 10px;
    }
    .stButton>button {
        width: 100%;
        border-radius: 5px;
        height: 3em;
    }
    .source-box {
        font-size: 0.8em;
        color: #666;
        background-color: #fff;
        padding: 5px;
        border-left: 3px solid #ff4b4b;
        margin-top: 5px;
    }
</style>
""", unsafe_allow_html=True)

# ==========================================
# çŠ¶æ€ç®¡ç† & åˆå§‹åŒ–
# ==========================================

if "messages" not in st.session_state:
    st.session_state.messages = []

if "session_id" not in st.session_state:
    st.session_state.session_id = "user_session_1"

if "system_initialized" not in st.session_state:
    st.session_state.system_initialized = False


# ç¼“å­˜ç³»ç»Ÿå®ä¾‹ï¼Œé¿å…æ¯æ¬¡åˆ·æ–°é‡è½½
@st.cache_resource
def get_system(api_key, api_base):
    try:
        sys = TurbineMachinerySystem(
            kb_path="./multimodel_doc_kb_memory_qwen_chunk",
            openai_api_key=api_key,
            openai_api_base=api_base,
            model_name="gemini-3-pro"  # æˆ–è€…ä½ çš„æ¨¡å‹ gpt-5-1
        )
        return sys
    except Exception as e:
        return None


# ==========================================
# ä¾§è¾¹æ ï¼šè®¾ç½®ä¸çŸ¥è¯†åº“
# ==========================================
with st.sidebar:
    st.title("âš™ï¸ ç³»ç»Ÿè®¾ç½®")

    # API è®¾ç½®
    api_key = st.text_input("OpenAI API Key", type="password", value=os.getenv("OPENAI_API_KEY", ""))
    api_base = st.text_input("API Base URL", value=os.getenv("OPENAI_API_BASE", "https://api.zchat.tech/v1"))

    if not api_key:
        st.warning("è¯·è¾“å…¥ API Key ä»¥å¯åŠ¨ç³»ç»Ÿ")
        st.stop()

    # åˆå§‹åŒ–ç³»ç»Ÿ
    system = get_system(api_key, api_base)
    if not system:
        st.error("ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚")
        st.stop()
    else:
        st.success("ç³»ç»Ÿåœ¨çº¿ ğŸŸ¢")

    st.divider()

    # ä¼šè¯ç®¡ç†
    st.subheader("ä¼šè¯ç®¡ç†")
    new_session = st.text_input("å½“å‰ä¼šè¯ ID", value=st.session_state.session_id)
    if new_session != st.session_state.session_id:
        st.session_state.session_id = new_session
        system.switch_session(new_session)
        st.session_state.messages = []  # åˆ‡æ¢ä¼šè¯æ—¶æ¸…ç©ºå‰ç«¯æ˜¾ç¤º
        st.rerun()

    if st.button("ğŸ—‘ï¸ æ¸…ç©ºå½“å‰ä¼šè¯å†å²"):
        system.clear_session_history(st.session_state.session_id)
        st.session_state.messages = []
        st.success("å†å²å·²æ¸…ç©º")
        time.sleep(1)
        st.rerun()

    st.divider()

    # çŸ¥è¯†åº“ç®¡ç†
    st.subheader("ğŸ“š çŸ¥è¯†åº“ç®¡ç†")

    # æ–‡ä»¶ä¸Šä¼ 
    uploaded_files = st.file_uploader("ä¸Šä¼ è¯¾ç¨‹æ–‡æ¡£ (PDF/Word/Txt)", accept_multiple_files=True)
    if uploaded_files:
        if st.button("å¼€å§‹å¤„ç†ä¸Šä¼ æ–‡ä»¶"):
            progress_bar = st.progress(0)
            status_text = st.empty()

            for idx, uploaded_file in enumerate(uploaded_files):
                status_text.text(f"æ­£åœ¨å¤„ç†: {uploaded_file.name}...")

                # ä¿å­˜ä¸´æ—¶æ–‡ä»¶
                with tempfile.NamedTemporaryFile(delete=False, suffix=Path(uploaded_file.name).suffix) as tmp_file:
                    tmp_file.write(uploaded_file.getvalue())
                    tmp_path = tmp_file.name

                # å®é™…ä¸Šåº”è¯¥æŠŠæ–‡ä»¶ç§»åŠ¨åˆ°çŸ¥è¯†åº“å¯ä»¥å¼•ç”¨çš„æŒä¹…åŒ–ä½ç½®ï¼Œæˆ–è€…ç›´æ¥ä¼ è·¯å¾„
                # è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å‡è®¾ add_document å¤„ç†è·¯å¾„
                # ä¸ºäº†ä¿æŒæ–‡ä»¶åï¼Œæˆ‘ä»¬å¤åˆ¶åˆ° ./temp_uploads ç›®å½•
                upload_dir = Path("./temp_uploads")
                upload_dir.mkdir(exist_ok=True)
                final_path = upload_dir / uploaded_file.name
                shutil.copy(tmp_path, final_path)

                success = system.add_document(str(final_path))
                if success:
                    st.toast(f"âœ… {uploaded_file.name} æ·»åŠ æˆåŠŸ")
                else:
                    st.toast(f"âŒ {uploaded_file.name} æ·»åŠ å¤±è´¥")

                progress_bar.progress((idx + 1) / len(uploaded_files))

            status_text.text("å¤„ç†å®Œæˆï¼")
            time.sleep(1)
            st.rerun()

    # æ–‡æ¡£åˆ—è¡¨
    with st.expander("æŸ¥çœ‹å·²ç´¢å¼•æ–‡æ¡£"):
        docs_info = system.list_documents()
        if docs_info and "documents" in docs_info:
            for path, meta in docs_info["documents"].items():
                col1, col2 = st.columns([4, 1])
                with col1:
                    st.text(f"ğŸ“„ {Path(path).name}")
                    st.caption(f"ç‰‡æ®µ: {meta.get('chunk_count')} | æ—¶é—´: {meta.get('added_at')}")
                with col2:
                    if st.button("åˆ é™¤", key=path):
                        system.delete_document(path)
                        st.rerun()
        else:
            st.info("æš‚æ— æ–‡æ¡£")

# ==========================================
# ä¸»ç•Œé¢é€»è¾‘
# ==========================================

st.title("âš™ï¸ é€å¹³æœºæ¢°åŸç†æ™ºèƒ½æ•™å­¦åŠ©æ‰‹")

# ä½¿ç”¨ Tab åˆ†éš”ä¸åŒåŠŸèƒ½
tab1, tab2, tab3, tab4 = st.tabs(["ğŸ’¬ æ™ºèƒ½é—®ç­”", "ğŸ“ ç”Ÿæˆç»ƒä¹ é¢˜", "âœï¸ ä½œä¸šæ‰¹æ”¹", "ğŸ“– ç« èŠ‚æ€»ç»“"])

# ----------------------------------------------------------------------
# TAB 1: æ™ºèƒ½é—®ç­” (Chat)
# ----------------------------------------------------------------------
with tab1:
    st.caption("åŸºäºå¤šæ–‡æ¡£ RAG æŠ€æœ¯ï¼Œæ”¯æŒå›¾æ–‡å¤šæ¨¡æ€å›ç­”ã€‚")

    # æ˜¾ç¤ºèŠå¤©è®°å½•
    for msg in st.session_state.messages:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])
            if "sources" in msg and msg["sources"]:
                with st.expander("å‚è€ƒèµ„æ–™æ¥æº"):
                    for src in msg["sources"]:
                        if src.get("type") == "image":
                            st.image(src["content_preview"], caption=src["file"], width=200)
                        else:
                            st.markdown(f"- **{src['file']}** (P{src['page']})")

    # å¤„ç†ç”¨æˆ·è¾“å…¥
    if prompt := st.chat_input("è¯·è¾“å…¥å…³äºé€å¹³æœºæ¢°çš„é—®é¢˜..."):
        # 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # 2. è°ƒç”¨åç«¯ç”Ÿæˆå›ç­”
        with st.chat_message("assistant"):
            with st.spinner("æ­£åœ¨æ£€ç´¢çŸ¥è¯†åº“å¹¶æ€è€ƒ..."):
                try:
                    # è°ƒç”¨ Agent
                    result = system.chat(prompt)
                    response_text = result["response"]
                    sources = result.get("sources", [])
                    confidence = result.get("confidence", 0.0)

                    # æ˜¾ç¤ºå›ç­”
                    st.markdown(response_text)

                    # æ˜¾ç¤ºç½®ä¿¡åº¦å¾½ç« 
                    if confidence > 0.7:
                        st.success(f"ç½®ä¿¡åº¦: High ({confidence:.2f})")
                    elif confidence > 0.4:
                        st.warning(f"ç½®ä¿¡åº¦: Medium ({confidence:.2f})")
                    else:
                        st.error(f"ç½®ä¿¡åº¦: Low ({confidence:.2f})")

                    # æ˜¾ç¤ºæ¥æº
                    if sources:
                        with st.expander("ğŸ“š å‚è€ƒèµ„æ–™æ¥æº"):
                            for src in sources:
                                if src.get("type") == "image":
                                    # å¤„ç†å›¾ç‰‡è·¯å¾„
                                    img_path = src["content_preview"].replace("Image Path: ", "")
                                    if os.path.exists(img_path):
                                        st.image(img_path, caption=f"æ’å›¾: {src['file']}", width=300)
                                else:
                                    st.markdown(
                                        f"- **æ–‡ä»¶**: {src['file']} | **é¡µç **: {src['page']} | **åˆ†æ•°**: {src['rerank_score']:.2f}")

                    # æ›´æ–° Session State
                    st.session_state.messages.append({
                        "role": "assistant",
                        "content": response_text,
                        "sources": sources
                    })

                except Exception as e:
                    st.error(f"å‘ç”Ÿé”™è¯¯: {str(e)}")

# ----------------------------------------------------------------------
# TAB 2: ç”Ÿæˆç»ƒä¹ é¢˜
# ----------------------------------------------------------------------
with tab2:
    st.header("æ™ºèƒ½å‡ºé¢˜")

    col1, col2 = st.columns(2)
    with col1:
        chapter = st.text_input("ç« èŠ‚/ä¸»é¢˜", value="è½´æµå¼å‹ç¼©æœº", help="è¾“å…¥ä½ æƒ³ç»ƒä¹ çš„ç« èŠ‚åç§°")
        count = st.number_input("é¢˜ç›®æ•°é‡", min_value=1, max_value=10, value=3)

    with col2:
        q_type = st.selectbox("é¢˜ç›®ç±»å‹",
                              options=["choice", "fill_blank", "short_answer", "calculation"],
                              format_func=lambda x:
                              {"choice": "é€‰æ‹©é¢˜", "fill_blank": "å¡«ç©ºé¢˜", "short_answer": "ç®€ç­”é¢˜",
                               "calculation": "è®¡ç®—é¢˜"}[x])
        difficulty = st.selectbox("éš¾åº¦ç­‰çº§", options=["easy", "medium", "hard"])

    if st.button("ğŸš€ ç”Ÿæˆé¢˜ç›®", type="primary"):
        with st.spinner("æ­£åœ¨åˆ†æçŸ¥è¯†ç‚¹å¹¶ç”Ÿæˆé¢˜ç›®..."):
            try:
                result = system.generate_questions(
                    chapter=chapter,
                    question_type=q_type,
                    count=count,
                    difficulty=difficulty
                )

                st.markdown("### ç”Ÿæˆç»“æœ")
                # åç«¯è¿”å›çš„ response å·²ç»æ˜¯æ ¼å¼åŒ–å¥½çš„ Markdown
                st.markdown(result["response"])

                # å¦‚æœæœ‰ç»“æ„åŒ–æ•°æ®ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰å±•ç¤ºï¼ˆå¯é€‰ï¼‰
                # st.json(result.get("questions", []))

            except Exception as e:
                st.error(f"ç”Ÿæˆå¤±è´¥: {e}")

# ----------------------------------------------------------------------
# TAB 3: ä½œä¸šæ‰¹æ”¹
# ----------------------------------------------------------------------
with tab3:
    st.header("æ™ºèƒ½ä½œä¸šæ‰¹æ”¹")

    st.info("æ”¯æŒç›´æ¥è¾“å…¥æ–‡æœ¬æˆ–ä¸Šä¼ æ–‡ä»¶ï¼ˆPDF/Wordï¼‰è¿›è¡Œæ‰¹æ”¹ã€‚")

    col_stu, col_ref = st.columns(2)

    # å­¦ç”Ÿç­”æ¡ˆè¾“å…¥
    with col_stu:
        st.subheader("ğŸ‘¨â€ğŸ“ å­¦ç”Ÿä½œä¸š")
        stu_tab1, stu_tab2 = st.tabs(["æ–‡æœ¬è¾“å…¥", "æ–‡ä»¶ä¸Šä¼ "])
        with stu_tab1:
            student_text = st.text_area("ç²˜è´´å­¦ç”Ÿç­”æ¡ˆ", height=200)
        with stu_tab2:
            student_file = st.file_uploader("ä¸Šä¼ ä½œä¸šæ–‡ä»¶", type=['pdf', 'docx', 'txt'], key="stu_file")

    # å‚è€ƒæ ‡å‡†è¾“å…¥
    with col_ref:
        st.subheader("ğŸ‘©â€ğŸ« å‚è€ƒæ ‡å‡† (å¯é€‰)")
        ref_tab1, ref_tab2 = st.tabs(["æ–‡æœ¬è¾“å…¥", "æ–‡ä»¶ä¸Šä¼ "])
        with ref_tab1:
            ref_text = st.text_area("ç²˜è´´æ ‡å‡†ç­”æ¡ˆ (ç•™ç©ºåˆ™è‡ªåŠ¨æ£€ç´¢)", height=200)
        with ref_tab2:
            ref_file = st.file_uploader("ä¸Šä¼ å‚è€ƒæ–‡ä»¶", type=['pdf', 'docx', 'txt'], key="ref_file")

    topic_input = st.text_input("ä½œä¸šä¸»é¢˜ (è¾…åŠ©æ£€ç´¢ï¼Œå¦‚ï¼šç¦»å¿ƒæœºæ•ˆç‡)", value="")

    if st.button("ğŸ“ å¼€å§‹æ‰¹æ”¹", type="primary"):
        if not student_text and not student_file:
            st.warning("è¯·è‡³å°‘æä¾›å­¦ç”Ÿç­”æ¡ˆå†…å®¹ã€‚")
        else:
            with st.spinner("æ­£åœ¨è§£ææ–‡ä»¶å¹¶è¯„ä¼°ç­”æ¡ˆ..."):
                # å¤„ç†æ–‡ä»¶è·¯å¾„
                s_path = ""
                r_path = ""


                # è¾…åŠ©å‡½æ•°ï¼šä¿å­˜ä¸Šä¼ æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
                def save_temp(uploaded_f):
                    if uploaded_f is None: return ""
                    with tempfile.NamedTemporaryFile(delete=False, suffix=Path(uploaded_f.name).suffix) as tf:
                        tf.write(uploaded_f.getvalue())
                        return tf.name


                s_path = save_temp(student_file)
                r_path = save_temp(ref_file)

                try:
                    result = system.grade_homework(
                        student_answer=student_text,
                        student_file=s_path,
                        reference=ref_text,
                        reference_file=r_path,
                        topic=topic_input
                    )

                    st.markdown("### æ‰¹æ”¹æŠ¥å‘Š")
                    st.markdown(result["response"])

                    # åªæœ‰å½“è§£ææˆåŠŸæ—¶ï¼Œgrading å­—æ®µé‡Œæ‰ä¼šæœ‰ç»“æ„åŒ–æ•°æ®
                    if "grading" in result and "score" in result["grading"]:
                        score = result["grading"]["score"]
                        st.progress(min(score, 100) / 100)

                except Exception as e:
                    st.error(f"æ‰¹æ”¹è¿‡ç¨‹ä¸­å‡ºé”™: {e}")
                finally:
                    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                    if s_path and os.path.exists(s_path): os.remove(s_path)
                    if r_path and os.path.exists(r_path): os.remove(r_path)

# ----------------------------------------------------------------------
# TAB 4: ç« èŠ‚æ€»ç»“
# ----------------------------------------------------------------------
with tab4:
    st.header("çŸ¥è¯†ç‚¹æ€»ç»“")
    summary_chapter = st.text_input("è¯·è¾“å…¥éœ€è¦æ€»ç»“çš„ç« èŠ‚åç§°", placeholder="ä¾‹å¦‚ï¼šå¤šçº§è½´æµå¼å‹ç¼©æœº")

    if st.button("ğŸ“‘ ç”Ÿæˆæ€»ç»“"):
        if not summary_chapter:
            st.warning("è¯·è¾“å…¥ç« èŠ‚åç§°")
        else:
            with st.spinner(f"æ­£åœ¨é˜…è¯»å¹¶æ€»ç»“ '{summary_chapter}' ç›¸å…³å†…å®¹..."):
                try:
                    summary_res = system.summarize_chapter(summary_chapter)
                    st.markdown(summary_res)
                except Exception as e:
                    st.error(f"æ€»ç»“å¤±è´¥: {e}")

# é¡µè„š
st.divider()
st.caption("Â© 2026 é€å¹³æœºæ¢°åŸç†è¯¾ç¨‹ç³»ç»Ÿ | Powered by LangGraph & RAG")
